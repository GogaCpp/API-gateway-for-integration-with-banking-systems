
# API-шлюз для взаимодействия с банковскими системами

## Цель и функциональные требования

Разработать API-шлюз для взаимодействия с банковскими системами:
- **ДБО (Дистанционное банковское обслуживание)** – для загрузки документов клиентами.
- **АБС (Автоматизированная банковская система)** – для хранения и обработки документов.
- **СМ (Система управления)** – для привязки документов к карточкам контрактов.

**Основные задачи:**
- Обеспечить защиту API с использованием **OAuth 2.0/JWT**.
- Разработать версионность API для поддержки будущих изменений.

---

## Общий стек для решения поставленной задачи

- **Язык программирования:** Python
- **Фреймворк:** FastAPI
- **База данных:** PostgreSQL (через SQLAlchemy и asyncpg)
- **Миграции:** Alembic
- **Конфигурация:** Pydantic Settings
- **Аутентификация:** JWT (через python-jose)
- **Хранение файлов:** aioboto3 (для работы с S3-хранилищем MinIO)
- **Тестирование:** pytest с поддержкой асинхронности
- **Сервер:** Uvicorn

---

## Описание сервисов

### ДБО (Дистанционное банковское обслуживание)
Сервис для загрузки документов клиентами, а также для работы с пользователем. Загрузка документов производится в **S3-хранилище MinIO**.

### АБС (Автоматизированная банковская система)
Сервис для хранения и обработки документов. В данном сервисе загруженные в **MinIO** файлы прикрепляются к объекту документа и сохраняются в **БД PostgreSQL**.

### СМ (Система управления)
Сервис для привязки документов к карточкам, а также для работы с самими связями между контрактом и документом.

---

## Тестовый сценарий

Воспроизведение поведения пользователей было проведено с помощью библиотеки **pytest** с поддержкой асинхронности.


Тестовый сценарий включает в себя использование 5 эндпоинтов для базовой работы с сервисами:

1. **Получение токена**  
   Эндпоинт: ```/api/v1/auth/token```

2. **Загрузка документа в S3-хранилище**  
   Эндпоинт: ```/api/v1/dbo/download_document```

3. **Создание объекта документа с использованием пути, полученного на предыдущем этапе**  
   Эндпоинт: ```/api/v1/abc/```

4. **Создание объекта контракта**  
   Эндпоинт: ```/api/v1/cm/```

5. **Привязка документа к контракту**  
   Эндпоинт: ```/api/v1/cm/connect_document```


## Запуск сервисов

1. Запуск образов Docker для PostgreSQL и MinIO

PostgreSQL:
```
docker run --name postgretest -e POSTGRES_USER=user -e POSTGRES_PASSWORD=1234 -e POSTGRES_DB=test -d -p 5432:5432 postgres
```

MinIO:
```
docker run -d \
  -p 9000:9000 \
  -p 9001:9001 \
  --name minio \
  -v /path/to/local/data:/data \
  -e "MINIO_ROOT_USER=myaccesskey" \
  -e "MINIO_ROOT_PASSWORD=mysecretkey" \
  quay.io/minio/minio server /data --console-address ":9001"
```

2. Создание .env файла

При запуске докеров как в примере выше надо:
```
cp .env.example .env
```

3. Создание виртуального окружения  и его активация
```
python3 -m venv .venv
source .venv/bin/activate
```

4. Установка зависимостей
```
pip install -r requirements.txt
```

5. Миграции
```
alembic upgrade head
```

6. Запуск сервисов
```
python -m src.main
```